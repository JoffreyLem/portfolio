stages:
  - build
  - docker-build
  - deploy

variables:
  IMAGE_TAG: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  IMAGE_TAG_LATEST: $CI_REGISTRY_IMAGE:latest
  DOCKER_HOST: unix:///var/run/docker.sock

# Cache partagé pour node_modules
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/

# Build & Test stage - Compilation et linting combinés
build:
  stage: build
  image: node:20-alpine
  script:
    - npm ci --prefer-offline --no-audit
    - npm run lint || true  # Ne bloque pas si le lint échoue
    - npm run build
  artifacts:
    paths:
      - .next/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
    - tags

# Docker build & push stage - Construction et publication de l'image
docker-build:
  stage: docker-build
  image: docker:latest
  variables:
    DOCKER_BUILDKIT: 1
    DOCKER_DRIVER: overlay2
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - |
      docker build \
        --build-arg BUILDKIT_INLINE_CACHE=1 \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=$CI_COMMIT_SHA \
        --build-arg VERSION=$CI_COMMIT_REF_SLUG \
        --cache-from $CI_REGISTRY_IMAGE:latest \
        -t $IMAGE_TAG \
        -t $IMAGE_TAG_LATEST \
        .
    - docker push $IMAGE_TAG
    - |
      if [ "$CI_COMMIT_REF_SLUG" == "main" ]; then
        docker push $IMAGE_TAG_LATEST
      fi
  dependencies:
    - build
  only:
    - main
    - develop
    - tags

# Deploy stage - Déploiement via runner Docker
deploy:
  stage: deploy
  image: docker:24
  before_script:
    # Connexion au registry GitLab
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
    # Arrêt et suppression de l'ancien conteneur s'il existe
    - |
      if docker ps -a | grep -q portfolio; then
        docker stop portfolio || true
        docker rm portfolio || true
      fi
  script:
    # Pull de l'image depuis le registry GitLab
    - echo "Récupération de l'image depuis le registry GitLab..."
    - docker pull $IMAGE_TAG
    - echo "Déploiement de l'application..."
    - |
      docker run -d \
        --name portfolio \
        --restart unless-stopped \
        -p 127.0.0.1:3000:3000 \
        -e NODE_ENV=production \
        -e NEXT_TELEMETRY_DISABLED=1 \
        $IMAGE_TAG
    # Vérification du déploiement
    - echo "Vérification du déploiement..."
    - sleep 5
    - docker ps | grep portfolio
    - docker logs --tail 20 portfolio
  only:
    - main
  environment:
    name: production
    url: https://portofolio.botbot.fr


